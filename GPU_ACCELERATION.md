# SAM API GPU 加速版使用指南

本文档详细介绍如何使用GPU加速版的SAM API服务，以获得更好的性能和更快的响应速度。

## 系统要求

1. **硬件要求**:
   - NVIDIA GPU，支持CUDA计算
   - 建议至少8GB GPU内存

2. **软件要求**:
   - NVIDIA GPU驱动
   - CUDA Toolkit 11.7+
   - Python 3.8+
   - PyTorch 2.0+（需要支持CUDA）

## 安装步骤

### 1. 安装CUDA环境

首先确保已经安装了NVIDIA GPU驱动和CUDA Toolkit，您可以通过以下命令检查:

```bash
nvidia-smi
```

这会显示您当前的GPU信息和CUDA版本。

### 2. 安装PyTorch (CUDA版本)

使用以下命令安装支持CUDA的PyTorch:

```bash
# 对于CUDA 12.x
py -m pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121

# 对于CUDA 11.x
py -m pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

### 3. 安装其他依赖

```bash
py -m pip install fastapi uvicorn pydantic numpy opencv-python matplotlib
```

### 4. 检查GPU配置

运行GPU检查工具确认您的环境已经正确配置:

```bash
.\check_gpu.bat
```

## 使用方法

### 启动GPU加速版SAM API

使用以下命令启动GPU加速版的SAM API服务:

```bash
.\start_gpu_sam_lite.bat
```

服务将在 http://127.0.0.1:9000 上运行。启动日志会显示:
- GPU 型号
- 是否启用GPU加速
- 数据目录位置

### 测试GPU性能

使用性能测试工具评估GPU加速效果:

```bash
.\test_gpu_performance.bat
```

这个测试会运行一系列基准测试，包括:
- 不同图像尺寸的分割性能测试
- 点击分割与自动掩码性能对比
- 性能测试结果汇总

## 功能增强

与CPU版相比，GPU加速版SAM API有以下增强:

1. **更快的响应速度**:
   - 点击分割: 速度提升3-10倍
   - 自动掩码生成: 速度提升2-5倍

2. **更智能的分割结果**:
   - 基于图像内容动态生成掩码
   - 根据图像复杂度自动调整掩码数量
   - 更自然的边缘和形状

3. **更丰富的元数据**:
   - 设备信息(GPU/CPU)
   - 处理时间统计
   - 更准确的质量分数

## 性能优化建议

1. **图像尺寸优化**:
   - 对于实时应用，建议将图像缩放到1024×1024以下
   - 大型图像(>2048×2048)可能需要更多GPU内存

2. **批量处理**:
   - 对于大量图像，建议使用批量处理而非逐个请求
   - 每批处理4-8张图像通常有最佳性能

3. **并发请求限制**:
   - 建议限制同时发送到API的并发请求数量
   - 通常不超过GPU数量的2倍

## 故障排除

### GPU内存不足

症状: 服务启动但返回错误，或者处理大图像时崩溃

解决方案:
- 减小处理的图像尺寸
- 关闭其他使用GPU的应用程序
- 考虑使用具有更多内存的GPU

### CUDA错误

症状: 启动服务时出现CUDA相关错误

解决方案:
- 确认PyTorch和CUDA版本匹配
- 更新GPU驱动到最新版本
- 尝试重新安装PyTorch

### 服务性能不如预期

症状: GPU版本速度提升不明显

解决方案:
- 运行`check_gpu.bat`确认GPU被正确识别
- 检查`http://127.0.0.1:9000/health`中的GPU状态
- 确保没有其他进程占用GPU资源

## 真实SAM API与精简版的区别

**真实版SAM API**:
- 加载实际的SAM模型进行推理
- 提供精确的分割结果
- 处理速度较慢，尤其在CPU模式下
- 需要下载大型模型权重文件(375MB-2.5GB)

**精简版SAM API (GPU加速)**:
- 不需要下载模型权重
- 生成模拟的分割结果，适合前端开发和测试
- 利用GPU加速模拟计算，提供更快的响应
- 适合API集成测试和用户界面开发

两个版本都可以利用GPU加速，但对于真实应用场景，推荐使用真实版SAM API。对于前端开发、测试和原型设计，精简版则提供更便捷的体验。

## 性能比较数据

以下是在NVIDIA GeForce RTX 4060笔记本GPU上的性能测试结果(仅供参考):

| 图像尺寸 | 操作类型 | CPU模式时间 | GPU模式时间 | 加速比 |
|----------|----------|-------------|-------------|--------|
| 256×256  | 点击分割 | ~0.6秒      | ~0.15秒     | 4.0x   |
| 512×512  | 点击分割 | ~0.8秒      | ~0.20秒     | 4.0x   |
| 1024×1024| 点击分割 | ~1.2秒      | ~0.25秒     | 4.8x   |
| 256×256  | 自动掩码 | ~1.2秒      | ~0.35秒     | 3.4x   |
| 512×512  | 自动掩码 | ~1.5秒      | ~0.45秒     | 3.3x   |
| 1024×1024| 自动掩码 | ~2.0秒      | ~0.60秒     | 3.3x   |

实际性能可能因硬件配置、系统负载和图像内容而有所不同。 